<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Compléter le profil - Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiMiPjgTY0E5Lrs2ZQOqR4WVWv76ETbRo",
      authDomain: "hirafiyin.firebaseapp.com",
      databaseURL: "https://hirafiyin-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hirafiyin",
      storageBucket: "hirafiyin.appspot.com",
      messagingSenderId: "484744901673",
      appId: "1:484744901673:web:8abd205006111bdfaf9838"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // رفع الصورة إلى Cloudinary
    async function uploadImageToCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "YOUR_UPLOAD_PRESET");
      formData.append("cloud_name", "dtyeh0izn");

      const response = await fetch(`https://api.cloudinary.com/v1_1/dtyeh0izn/image/upload`, {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      return data.secure_url;
    }

    // معاينة الصورة المرفوعة
    window.previewFile = () => {
      const fileInput = document.getElementById("image");
      const previewImage = document.getElementById("previewImage");
      const previewText = document.getElementById("previewText");
      const resetBtn = document.getElementById("resetBtn");

      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          previewImage.src = reader.result;
          previewImage.classList.remove("hidden");
          previewText.classList.add("hidden");
          resetBtn.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    };

    window.resetImage = () => {
      const fileInput = document.getElementById("image");
      fileInput.value = "";
      document.getElementById("previewImage").classList.add("hidden");
      document.getElementById("previewText").classList.remove("hidden");
      document.getElementById("resetBtn").classList.add("hidden");
    };

    // حفظ البيانات في Firebase
    window.saveProfile = async () => {
      const fileInput = document.getElementById("image");
      let imageUrl = "";
      
      if (fileInput.files[0]) {
        imageUrl = await uploadImageToCloudinary(fileInput.files[0]);
      }

      const data = {
        nom: document.getElementById("nom").value,
        telephone: document.getElementById("telephone").value,
        wilaya: document.getElementById("wilaya").value,
        daira: document.getElementById("daira").value,
        codePostal: document.getElementById("codePostal").value,
        adresse: document.getElementById("adresse").value,
        photo: imageUrl,
        preferences: document.getElementById("preferences").value
      };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          const clientRef = ref(db, 'clients/' + user.uid);
          set(clientRef, data)
            .then(() => {
              alert("Profil enregistré avec succès !");
              window.location.href = "client-dashboard.html";
            })
            .catch((error) => {
              console.error("Erreur:", error);
              alert("Une erreur s'est produite lors de l'enregistrement.");
            });
        } else {
          alert("Utilisateur non connecté !");
        }
      });
    };
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-xl space-y-4">
    <h2 class="text-2xl font-bold text-center text-blue-700">Compléter votre profil</h2>

    <!-- Upload de l'image -->
    <div class="text-center">
      <label for="image" class="block text-sm font-medium text-gray-700 mb-2">Photo de profil</label>
      <div class="flex justify-center">
        <label for="image" class="cursor-pointer">
          <div id="imagePreviewContainer" class="w-40 h-40 rounded-full border-4 border-dashed border-blue-400 flex items-center justify-center overflow-hidden bg-gray-100 hover:bg-gray-200 transition">
            <span id="previewText" class="text-gray-500 text-sm">Cliquez pour choisir une photo</span>
            <img id="previewImage" class="hidden w-full h-full object-cover" />
          </div>
        </label>
        <input id="image" name="image" type="file" accept="image/*" class="hidden" onchange="previewFile()">
      </div>
      <button onclick="resetImage()" class="mt-2 text-sm text-red-600 hover:underline hidden" id="resetBtn">Changer la photo</button>
    </div>

    <!-- Informations -->
    <div><label class="block mb-1 font-semibold">Nom Complet</label>
      <input id="nom" type="text" class="w-full border p-2 rounded-md" placeholder="Entrez votre nom" required>
    </div>
    <div><label class="block mb-1 font-semibold">Numéro de téléphone</label>
      <input id="telephone" type="tel" class="w-full border p-2 rounded-md" placeholder="+213 6xx xx xx xx" required>
    </div>
    <div><label class="block mb-1 font-semibold">Préférences</label>
      <textarea id="preferences" class="w-full border p-2 rounded-md" rows="2" placeholder="Décrivez vos préférences pour les artisans..."></textarea>
    </div>
    <div><label class="block mb-1 font-semibold">Wilaya</label>
      <input id="wilaya" type="text" class="w-full border p-2 rounded-md" placeholder="Ex: Alger" required>
    </div>
    <div><label class="block mb-1 font-semibold">Daira</label>
      <input id="daira" type="text" class="w-full border p-2 rounded-md" placeholder="Ex: Bab El Oued" required>
    </div>
    <div><label class="block mb-1 font-semibold">Code Postal</label>
      <input id="codePostal" type="text" class="w-full border p-2 rounded-md" placeholder="16000" required>
    </div>
    <div><label class="block mb-1 font-semibold">Adresse</label>
      <textarea id="adresse" class="w-full border p-2 rounded-md" rows="2" placeholder="Rue 20 août..." required></textarea>
    </div>

    <div class="text-center">
      <button onclick="saveProfile()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Enregistrer
      </button>
    </div>
  </div>
</body>
</html>

